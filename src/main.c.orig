#include <stdio.h>
#include "philosophers.h"

void	*supervise(void *arg)
{
	t_local_data	**local;
	unsigned int	current_time;
	unsigned int	last_meal;
	unsigned int	time_to_die;

	local = (t_local_data **)arg;
	while (1)
	{
<<<<<<< Updated upstream
		current_time = get_day_us();
		for (int i = 0; i < local[0]->shared_data->philo_count; i++)
		{
			last_meal = local[i]->time_last_meal * 1000;
			time_to_die = local[0]->shared_data->time_to_die * 1000;
=======
		///*
		for (int i = 0; i < local[0]->shared_data->philo_count; i++)
		{
			pthread_mutex_lock(&local[i]->time_last_meal.mutex);
			current_time = get_day_us();
			last_meal = local[i]->time_last_meal.value * 1000;
			time_to_die = local[i]->shared_data->time_to_die * 1000;
>>>>>>> Stashed changes
			if (last_meal && current_time - last_meal > time_to_die)
			{
				pthread_mutex_lock(&local[i]->shared_data->print_token);
				local[0]->shared_data->death_record = local[i]->id;
				print_message(local[i], "died\n", 1);
<<<<<<< Updated upstream
				pthread_mutex_unlock(&local[i]->shared_data->print_token);
				//printf("curr %u, last %u, time to die %u, did not eating since %u\n", current_time, last_meal, time_to_die, current_time - last_meal);
=======
				//pthread_mutex_unlock(&local[i]->shared_data->print_token);
				printf("real %u curr %u, last %u, time to die %u, did not eating since %u\n", (get_day_ms() - local[i]->time_init), current_time / 1000 -local[i]->time_init , last_meal / 1000 - local[i]->time_init, time_to_die, (current_time - last_meal) / 1000);
>>>>>>> Stashed changes
				return (arg);
			}
			//else printf("curr %u, last %u, time to die %u, did not eating since %u\n", current_time, last_meal, time_to_die, current_time - last_meal);
		}
<<<<<<< Updated upstream
		usleep(5);
=======
		//*/
		usleep(50);

>>>>>>> Stashed changes
	}
}

void run_threads(t_local_data **local)
{
	pthread_t threadId[local[0]->shared_data->philo_count];
	initalize_muteces(local[0]->shared_data);
	for (int i = 0; i < local[0]->shared_data->philo_count; i++)
		if (pthread_create(&threadId[i], NULL, philosophizing, local[i]))
			puts("error while creating threads");
	supervise((void* )local);
}

#ifndef IS_TEST

int	main(int argc, char **argv)
{
	t_local_data	**local;

	if (! is_input_valid(argc, argv))
		return (1);
	ft_fast_putstr("is valid\n");
	local = set_up(5, argv);
	ft_fast_putstr("set up done\n");
	if (! local)
		return (1);
	ft_fast_putstr("reached thread\n");
	run_threads(local);
	return (0);
}

#endif
